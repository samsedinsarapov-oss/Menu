import telebot
from telebot import types
import json

# –¢–≤–æ–π —Ç–æ–∫–µ–Ω
TOKEN = '8584017257:AAEc_NFvlRBqp62PL6eTkL2JqYlHkfYFFOs'
# –¢–≤–æ–π ID (–¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∑–∞–∫–∞–∑–æ–≤)
ADMIN_ID = 7754554184 

bot = telebot.TeleBot(TOKEN)
user_orders = {}

@bot.message_handler(commands=['start'])
def start(message):
    markup = types.ReplyKeyboardMarkup(resize_keyboard=True)
    # –ó–ê–ú–ï–ù–ò –°–°–´–õ–ö–£ –ù–ò–ñ–ï –Ω–∞ —Å–≤–æ—é —Å—Å—ã–ª–∫—É –æ—Ç GitHub Pages
    web_app = types.WebAppInfo("https://—Ç–≤–æ–π-–ª–æ–≥–∏–Ω.github.io/index.html")
    markup.add(types.KeyboardButton("üçΩ –û—Ç–∫—Ä—ã—Ç—å –º–µ–Ω—é", web_app=web_app))
    
    bot.send_message(
        message.chat.id, 
        "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å –±–ª—é–¥–∞:", 
        reply_markup=markup
    )

# 1. –ü–æ–ª—É—á–∞–µ–º –≤—ã–±–æ—Ä –∏–∑ Web App
@bot.message_handler(content_types=['web_app_data'])
def handle_web_app_data(message):
    data = json.loads(message.web_app_data.data)
    user_orders[message.chat.id] = data
    
    markup = types.ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=True)
    markup.add(types.KeyboardButton("üì± –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞", request_contact=True))
    
    bot.send_message(
        message.chat.id, 
        f"–í—ã –≤—ã–±—Ä–∞–ª–∏: {data['item']}\n–¶–µ–Ω–∞: {data['price']}\n\n–¢–µ–ø–µ—Ä—å –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –≤–∞—à –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –¥–ª—è —Å–≤—è–∑–∏:", 
        reply_markup=markup
    )

# 2. –ü–æ–ª—É—á–∞–µ–º –∫–æ–Ω—Ç–∞–∫—Ç –∏ —Å–ø—Ä–∞—à–∏–≤–∞–µ–º —Å–ø–æ—Å–æ–± –ø–æ–ª—É—á–µ–Ω–∏—è
@bot.message_handler(content_types=['contact'])
def handle_contact(message):
    chat_id = message.chat.id
    if chat_id in user_orders:
        user_orders[chat_id]['phone'] = message.contact.phone_number
        
        markup = types.ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=True)
        markup.add("üèÉ –°–∞–º–æ–≤—ã–≤–æ–∑", "üöñ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ —Ç–∞–∫—Å–∏")
        
        bot.send_message(chat_id, "–ö–∞–∫ –≤—ã —Ö–æ—Ç–∏—Ç–µ –ø–æ–ª—É—á–∏—Ç—å –∑–∞–∫–∞–∑?", reply_markup=markup)

# 3. –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ (–°–∞–º–æ–≤—ã–≤–æ–∑ –∏–ª–∏ –¢–∞–∫—Å–∏)
@bot.message_handler(func=lambda message: message.text in ["üèÉ –°–∞–º–æ–≤—ã–≤–æ–∑", "üöñ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ —Ç–∞–∫—Å–∏"])
def handle_delivery_method(message):
    chat_id = message.chat.id
    if chat_id in user_orders:
        user_orders[chat_id]['method'] = message.text
        
        if message.text == "üöñ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ —Ç–∞–∫—Å–∏":
            markup = types.ReplyKeyboardMarkup(resize_keyboard=True)
            markup.add(types.KeyboardButton("üìç –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ª–æ–∫–∞—Ü–∏—é", request_location=True))
            bot.send_message(chat_id, "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –≤–∞—à—É –ª–æ–∫–∞—Ü–∏—é, —á—Ç–æ–±—ã –º—ã –º–æ–≥–ª–∏ –≤—ã–∑–≤–∞—Ç—å —Ç–∞–∫—Å–∏:", reply_markup=markup)
        else:
            send_to_admin(message)

# 4. –ü–æ–ª—É—á–∞–µ–º –ª–æ–∫–∞—Ü–∏—é (–µ—Å–ª–∏ —Ç–∞–∫—Å–∏)
@bot.message_handler(content_types=['location'])
def handle_location(message):
    chat_id = message.chat.id
    if chat_id in user_orders:
        user_orders[chat_id]['lat'] = message.location.latitude
        user_orders[chat_id]['lon'] = message.location.longitude
        send_to_admin(message)

# –§–∏–Ω–∞–ª: –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∞–¥–º–∏–Ω—É
def send_to_admin(message):
    chat_id = message.chat.id
    order = user_orders[chat_id]
    
    admin_msg = f"üîî –ù–û–í–´–ô –ó–ê–ö–ê–ó!\n\n" \
                f"üçï –ë–ª—é–¥–æ: {order['item']}\n" \
                f"üí∞ –¶–µ–Ω–∞: {order['price']}\n" \
                f"üìû –¢–µ–ª–µ—Ñ–æ–Ω: {order['phone']}\n" \
                f"üì¶ –°–ø–æ—Å–æ–±: {order['method']}"
    
    bot.send_message(ADMIN_ID, admin_msg)
    
    # –ï—Å–ª–∏ –µ—Å—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã ‚Äî —à–ª–µ–º –∫–∞—Ä—Ç—É –∞–¥–º–∏–Ω—É
    if 'lat' in order:
        bot.send_location(ADMIN_ID, order['lat'], order['lon'])
        bot.send_message(ADMIN_ID, "‚òùÔ∏è –≠—Ç–æ –∞–¥—Ä–µ—Å –∫–ª–∏–µ–Ω—Ç–∞ –¥–ª—è —Ç–∞–∫—Å–∏—Å—Ç–∞.")

    bot.send_message(chat_id, "‚úÖ –°–ø–∞—Å–∏–±–æ! –í–∞—à –∑–∞–∫–∞–∑ –ø—Ä–∏–Ω—è—Ç. –ú—ã —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏.", reply_markup=types.ReplyKeyboardRemove())
    del user_orders[chat_id]

if __name__ == '__main__':
    bot.polling(none_stop=True)
